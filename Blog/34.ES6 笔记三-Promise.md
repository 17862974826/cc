# ES6 笔记三 - Promise

***ES6规范确认以前，写过一个Promise的[简单实现](https://github.com/ccforward/cc/tree/master/promise)***

Promise就是一个容器，里面保存着某个未来才会结束的事件(一个异步操作)的结果。作为一个对象，从Promise可以获取异步操作的消息。

## 两个特点

1. 对象的状态不受外界影响。  
	Promise对象代表一个异步操作，有三种状态：`Pending`(进行中) `Resolved`(已完成 Fullfilled) `Rejected`(已失败)。  
	只有异步操作的结果，可以决定当前是哪一种状态，任何操作都无法改变这个状态。
2. 一旦状态改变，就不会再变，任何时候都可以得到这个结果。  
	Promise的状态改变只有两种可能：Pending -> Resolved 或者 Pending -> Rejected。  
	只要两种情况发生，状态就固定不会改变了，会一直保持这个结果。
	
通过Promise对象就可以将异步操作以同步操作的流程表达出来，避免嵌套层层回调的地狱。

## 缺点

* 无法取消Promise，一旦新建它就会立即执行，无法中途取消
* 如果不设置回调函数，Promise内部抛出的错误，不会反应到外部
* 当处于Pending状态时，无法得知目前进展到哪一个阶段（刚刚开始还是即将完成）


## 用 Promise 对象实现一个Ajax

```js
var getJSON = function(url){
	var promise = new Promise(function(){
		var xhr = new XMLHttpRequest();
		xhr.open('GET', url);
		xhr.onreadystatechange = hanlder;
		xhr.responseType = 'json';
		xhr.setRequestHeader('Accept', 'application/json');
		xhr.send();
		
		function hanlder(){
			if(this.readyState !== 4){
				return;
			}
			if(this.status == 200){
				resolve(this.response);
			} else {
				reject(new Error(this.statusText));
		}
	});
	
	return promise;
}
```

如果调用 resolve 或者 reject 函数时带有参数，那么这些参数会传递给回调函数。 reject的参数通常是 Error 对象的实例，表示跑出的错误。

## Promise.prototype.then

then 方法是为 Promise 实例添加状态改变时的回调函数。then方法的第一个参数是 Resolved 状态的回调函数，第二个参数（可选）是 Rejected 状态的回调函数。 

then方法返回的是一个新的Promise实例（不是原来那个），可采用链式写法。